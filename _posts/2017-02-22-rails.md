---
layout: post
title: rails
---
[RailsFun.tw 新手教學 day2 HD](https://www.youtube.com/watch?v=O7AoNPfUFno)

#### 安裝
`sudo apt-get install libmysqlclient-dev`    
`rails new project --datebase=mysql`  
`gem i mysql2`
<!--more-->
`rail --help`  

修改config/database.yml設定mysql帳號密碼

要用的gem都要寫到Gemfile  
`bundle install` (依照Gemfile安裝)  
`rails c` (console mode)  
`rake -T` (列出所有可用指令)  

rails下資料夾  
public 網站根目錄  
lib  
vendor 第三方外掛  
log  
db  
config 				所有設定檔  
  database.yml 		設定資料庫  
  application.rb	  
  environment.rb  
  enviroments/  
  initializers		rails開機執行  
  secrets.yml  
app/  

#### 啟動順序  
environment.rb   
  -> application.rb(bundler)   
  -> environments/RAILS_ENV.rb   
  -> initailizers  

#### migration  
> 利用ruby方便有條理的修改資料庫,並自動追蹤資料庫版本  


`rails g migration init_db`  建立空的版本(init_db)   
`rake db:drop`  刪除資料表   
`rake db:create`  建立資料表  
`rake db:migrate`   升版   
`rake db:rollback`  降版 

```
class AddPosts < ActiveRecord::Migration
   def change
      create_table :posts do |t|
      t.string :title
    end
  end
end
```
change做的事  
`rake db:migrate`做create_table  
`rake db:rollback`做相反於change的動作(drop_table)  

在table中的 schema migrations 紀錄所有升降的版本紀錄    

t.timestamp : created_at  
t.timestamp : updated_at  
兩句等於 t.timestamps   

`:null => false` 不能為空  

#### ORM    
操控object同時在操控DB  

polymorphism  
type保留字    
relation  


2:14:     
route -> controller/ action -> view/ Helper/ Layout/ partial(sub HTML)  

```
config/routes.rb 

  1 Rails.application.routes.draw do
  2     resources :items
  3     root 'ites#index'
  4   # For details on the DSL available within this file,
      #see http://guides.rub  yonrails.org/routing.html
  5 end

```
`rake routes`  
```
   Prefix Verb   URI Pattern               Controller#Action
    items GET    /items(.:format)          items#index
          POST   /items(.:format)          items#create
 new_item GET    /items/new(.:format)      items#new
edit_item GET    /items/:id/edit(.:format) items#edit
     item GET    /items/:id(.:format)      items#show
          PATCH  /items/:id(.:format)      items#update
          PUT    /items/:id(.:format)      items#update
          DELETE /items/:id(.:format)      items#destroy
     root GET    /                         ites#index

```
#### restful    
e.g. https//www.google.com/items/edit/1/create  
多加一個變數Verb (POST/GET/DELETE/PATCH/PUT)  
利用header不同導到不同網址, 不會全部塞到網址列後面

```
config/routes.rb 

  1 Rails.application.routes.draw do
  2     get "/yoo/123", :to => "items#yoo"
  3 end
```
輸入網址後輸入"/yoo/123"會到items#yoo (controller#action)  
```
Prefix Verb URI Pattern        Controller#Action
yoo_123 GET  /yoo/123(.:format) items#yoo

```

`rails s -b 0.0.0.0`  
這樣才能給外部IP使用  
yourIP:3000 or localhost:3000  

```
app/controllers/items_controller.rb

  1 class ItemsController < ApplicationController
  2     def yoo
  3         render :text => 'hihi'
  4     end
  5 end

```
用controller處理items#yoo  
執行yoo,回傳文字hihi  

```
app/controllers/items_controller.rb

  1 class ItemsController < ApplicationController
  2     def yoo
  3         @item = 123
  4     end
  5 end

app/views/items/yoo.html.erb

 1 <%= @item %>
```
在controller中@變數,可以直接在view使用  
view的檔名為xxx.html(xml).erb  
`<%= %>` =表示印在頁面上  

#### callback  
```
class ItemsController < ApplicationController
  before_action :func1
  
  def yoo
    @item = 123

  private
  def func1  
    @yoo = "kitty"
  end
end
```
在執行controller之前,會先執行callback(func1)  


#### render action
render :action => :hoo  
拿別人的view來用    


#### redirect    
```
redirect_to :action => :hoo
```

view有做html escape  
```
app/views/items/yoo.html.erb

 1 <%= "<hr><p>im_html</p>"%>

<%= h("<hr><p>im_html</p>)"%>    //預設不解譯
<%= raw("<hr><p>im_html</p>)"%>  //解譯
```
在網頁上不會解譯html,預防XSS攻擊  
括號會幫你翻譯成&lt,&gt的編碼  


#### helper  
在`app/helpers/application_helper.rb`中定義function  
在view就可以直接使用helper中定義的function  

#### partial
部份的HTML, 並在HTML中render partial  
partial命名用_開頭 

scaffold  
`rail g scaffold --help`  
幫你一次建立好基本的migrate/ route/ controller/ views/  


<hr>
[RailsFun.tw 新手教學 day2.5 HD](https://www.youtube.com/watch?v=r2sLYTQwgtQ)

`rails new shop --database=mysql`  
修改`config/database.yml` user and password   

```
Gemfile

gem 'will_paginate'  
gem 'awesome_print'  
gem 'rails-pry'  
gem 'devise'  
gem 'paperclip'
```
`bundle install`安裝  

```
config/routes.rb

  1 Rails.application.routes.draw do
  2   devise_for :managers
  3   devise_for :users
  4     resource :statics , :only => [:index]
  5     root "statics#index"
  6     resources :items , :only => [:index, :show]
  7     namespace :dashboard do
  8         resources :orders
  9         namespace :admin do
 10             resources :items
 11             resources :cates
 12             resources :orders
 13             resources :users
 14 
 15             resources :users
 16             resources :managers
 17         end
 18     end
 19 end
```
namespace 利用網址做分層結構  
利用devise gem做登入系統  

`rails generate devise:install`    
`rails generate devise User`  
`rails generate devise Manager`  
`rake db:create db:migrate`   
`rails g migration init_shop`  

24:35  
```
db/migrate/20170224081403_init_shop.rb

  1 class InitShop < ActiveRecord::Migration[5.0]
  2   def change
  3       create_table :cates do |t|
  4           t.string :name
  5           t.integer :position
  6           t.timestamps
  7       end
  8       create_table :items do |t|
  9           t.integer :status , :limit => 1 , :default => 0 , :null => false
 10           t.string :name
 11           t.integer :price
 12           t.text :descript
 13           t.timestamps
 14           t.timestamp :delete_at
 15       end
 16       create_table :orders do |t|
 17           t.integer :user_id
 18           t.timestamps
 19           t.integer :status , :limit => 1 , :null => false , :default => 0
 20           t.integer :total  , :default => 0, :null => false
 21       end
 22       create_table :order_items do |t|
 23           t.integer :order_id , :null => false
 24           t.integer :item_id  , :null => false
 25           t.integer :user_id  , :null => false
 26           t.integer :price    , :null => false
 27       end
 28       add_index :order_items , [:order_id]
 29   end
 30 end

```
`rake db:migrate`  
[Paperclip](https://github.com/thoughtbot/paperclip)  
`sudo apt-get install imagemagick`    
`rails g migration add_item_cover`   
```
db/migrate/20170224094537_add_item_cover.rb

  1 class AddItemCover < ActiveRecord::Migration[5.0]
  2   def up
  3       add_attachment :items, :cover
  4   end
  5   def down
  6       remove_attachment :items, :cover
  7   end
  8 end
```

```
app/models/manager.rb 
 
  1 class Manager < ApplicationRecord
  2   # Include default devise modules. Others available are:
  3   # :confirmable, :lockable, :timeoutable and :omniauthable
  4   devise :database_authenticatable#, :registerable
  5         #:recoverable, :rememberable, :trackable, :validatable
  6 end

app/models/user.rb 

  1 class User < ApplicationRecord
  2   # Include default devise modules. Others available are:
  3   # :confirmable, :lockable, :timeoutable and :omniauthable
  4   devise :database_authenticatable, :registerable
  5          #:recoverable, :rememberable, :trackable, :validatable
  6 end
```
`rails g migration add_item_cate`  
```
db/migrate/20170224100442_add_item_cate.rb
  1 class AddItemCate < ActiveRecord::Migration[5.0]
  2   def change
  3       add_column :items, :cate_id , :integer , :null => false
  4   end
  5 end
```
```
app/models/item.rb 
  1 class Item < ActiveRecord::Base
  2   belongs_to :cate
  3   has_attached_file :cover ,
  4      styles: { 
  5         original: "1024x1024>",
  6         cover: "300x300>",
  7         icon: "150x150#"
  8      }, 
  9     default_url: "/images/:style/missing.png"
 10   validates_attachment_content_type :cover , content_type: /\Aimage\/.*\z/
 11 end
```
```
app/models/cate.rb

  1 class Cate < ActiveRecord::Base
  2     has_many :item
  3 end
```
```
app/models/order.rb

  1 class Order < ActiveRecord::Base
  2     has_many :order_item
  3 end
```
```
app/models/order_item.rb

  1 class OrderItem < ActiveRecord::Base
  2     belongs_to :item
  3     belongs_to :user
  4     belongs_to :order
  5 end
```
```
app/controllers/dashboard/dashboard_controller.rb

  1 class Dashboard::DashboardController < ApplicationController
  2     before_action :authenticate_user!
  3 end
```
```
app/controllers/dashboard/orders_controller.rb

  1 class Dashboard::OrdersController <  Dashboard::DashboardController
  2 
  3 end
```
```
app/controllers/dashboard/admin/admin_controller.rb

  1 class Dashboard::Admin::AdminController < ApplicationController
  2     before_action :authenticate_manager!
  3 end
```
```
app/controllers/dashboard/admin/items_controller.rb

  1 class Dashboard::Admin::ItemsController < Dashboard::Admin::AdminController
  2 end

```
在console mode下建立manerger帳號密碼  
`rails c`  
Manager.create(:email => 'test@test', :password => 'testtest')

```
app/controllers/statics_controller.rb

  1 class StaticsController < ApplicationController
  2     def index
  3         @items = @paginate = Item.paginate(:page => params[:page])
  4     end
  5 end
```
```
app/controllers/items_controller.rb

  1 class ItemsController < ApplicationController
  2     def index
  3         @items = @paginate = Item.paginate(:page => params[:page])])
  4     end
  5     def show
  6         @item  = Item.find(params[:id])
  7     end
  8 end
```
```text
app/views/layouts/application.html.erb

  1 <!DOCTYPE html>
  2 <html>
  3   <head>
  4     <title>Shop</title>
  5     <%= csrf_meta_tags %>
  6 
  7     <%= stylesheet_link_tag    'application', media: 'all' %>
  8     <%= javascript_include_tag 'application' %>
  9   </head>
 10 <body>
 11 
 12 <% if current_user %>
 13     Hi! <%= current_user.email %> , <%= link_to "logout", destroy_user_ses    sion_path, :method => 'delete' %>
 14 <% else %>
 15     <%= link_to 'login', new_user_session_path %>, <%= link_to 'registered    ', new_user_registration_path %>
 16 <% end %>
 17 <hr>
 18 <%= will_paginate @paginate if @paginate %>
 19 <hr>
 20 <%= yield %>
 21 <hr>
 22 <%= will_paginate @paginate if @paginate %>
 23 
 24 </body>
 25 </html>
```